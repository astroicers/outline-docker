# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Docker deployment of Outline Wiki v1.4 with Keycloak OIDC authentication, Nginx reverse proxy, and Let's Encrypt SSL.

## Architecture

```
Internet → Nginx (80/443)
              ├── wiki.example.com → Outline (3000)
              └── auth.example.com → Keycloak (8080)
                          ↓
                    PostgreSQL + Redis
```

- **Nginx**: Reverse proxy with SSL termination
- **Outline**: Wiki application on internal port 3000
- **Keycloak**: OIDC identity provider on internal port 8080
- **PostgreSQL 15**: Database for both Outline and Keycloak
- **Redis 7**: Session/cache store

## Key Files

- `docker-compose.yml` - Service definitions
- `.env` - Environment variables (DO NOT COMMIT)
- `setup.sh` - Interactive setup script
- `keycloak/outline-realm.json` - Keycloak realm config (generated by setup.sh)
- `nginx/conf.d/outline.conf.ssl` - SSL Nginx config template
- `nginx/conf.d/outline-temp.conf.bak` - HTTP-only config for cert generation

## Common Commands

```bash
# Service management
docker compose up -d                    # Start all services
docker compose down                     # Stop services
docker compose logs -f [service]        # View logs
docker compose restart [service]        # Restart service

# Database
docker compose exec postgres psql -U outline              # Outline DB
docker compose exec postgres psql -U outline keycloak     # Keycloak DB

# Backup
docker compose exec postgres pg_dump -U outline outline > outline-backup.sql
docker compose exec postgres pg_dump -U outline keycloak > keycloak-backup.sql
```

## Setup Flow

1. Run `./setup.sh` - generates `.env`, updates configs with user's domains
2. Start postgres, redis, nginx
3. Create keycloak database
4. Run certbot for SSL
5. Copy SSL config and start all services

## Configuration Notes

- OIDC authentication via Keycloak (not Google OAuth)
- First Keycloak user to login becomes Outline admin
- Let's Encrypt certificates expire in 90 days
- WebSocket support configured for real-time collaboration
- Rate limiting: 1000 requests per 60 seconds
- Max upload size: 256MB
