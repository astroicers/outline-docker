# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Docker deployment of Outline Wiki v1.4 with Keycloak OIDC authentication, Nginx reverse proxy, and Let's Encrypt SSL.

## Architecture

```
Internet → Nginx (80/443)
              ├── wiki.example.com → Outline (3000)
              └── auth.example.com → Keycloak (8080)
                          ↓
                    PostgreSQL + Redis
```

- **Nginx**: Reverse proxy with SSL termination
- **Outline**: Wiki application on internal port 3000
- **Keycloak**: OIDC identity provider on internal port 8080
- **PostgreSQL 15**: Database for both Outline and Keycloak
- **Redis 7**: Session/cache store

## Key Files

- `docker-compose.yml` - Service definitions
- `.env` - Environment variables (DO NOT COMMIT)
- `scripts/setup.sh` - Interactive setup script
- `scripts/init-keycloak-db.sql` - Keycloak database initialization
- `keycloak/outline-realm.json` - Keycloak realm config (generated by setup.sh)
- `nginx/templates/outline.conf.template` - SSL Nginx config template
- `nginx/templates/outline-temp.conf.template` - HTTP-only config for cert generation

## Common Commands

```bash
# 使用 Makefile (推薦)
make help             # 查看所有指令
make validate         # 執行驗證 (推版前必跑)
make up               # 啟動所有服務
make down             # 停止服務
make logs             # 查看日誌
make backup           # 備份資料庫

# 或直接使用 docker compose
docker compose up -d                    # Start all services
docker compose down                     # Stop services
docker compose logs -f [service]        # View logs
docker compose restart [service]        # Restart service
```

## Setup Flow

1. Run `./scripts/setup.sh` - generates `.env`, updates configs with user's domains
2. Start postgres, redis, nginx
3. Create keycloak database
4. Run certbot for SSL
5. Copy SSL config and start all services

## Configuration Notes

- OIDC authentication via Keycloak (not Google OAuth)
- First Keycloak user to login becomes Outline admin
- Let's Encrypt certificates expire in 90 days
- WebSocket support configured for real-time collaboration
- Rate limiting: 1000 requests per 60 seconds
- Max upload size: 256MB

## Development Workflow (SDD)

1. **撰寫規格**: `make new-spec` 建立規格文件到 `docs/specs/`
2. **規格審核**: PR review 或自行確認
3. **實作變更**: 根據規格修改程式碼
4. **執行驗證**: `make validate` (推版前必跑)
5. **提交 PR**: CI 自動執行驗證
6. **合併**: 驗證通過後合併

## Testing

```bash
make validate         # 執行所有驗證
make validate-quick   # 快速驗證 (不需 Docker)
```

驗證項目：
- ShellCheck: Shell 腳本語法檢查
- yamllint: YAML 格式驗證
- jq: JSON 格式驗證
- Docker Compose: 設定驗證
- 必要檔案檢查
